var test = require('tap').test
var cs = require('../stream').controlStream
var read = require('../stream').reader
var es = require('event-stream')

test('test controlStream.pipe', function(t){
	var stream = new cs()
	var array = makeBuffArray()
	var array2 = []
	var array3 = []
	es.readArray(array).pipe(stream).pipe(
		es.through(function write(data){
			array2.push(data)
		}, function end(){
			t.same(array[1],array2[1], '2 arrays should be equal')
		
		}),
	{pace:20})
	
	process.nextTick(function(){
		stream.pipe(es.through(function write(data){
			array3.push(data)
		}, function end(){
			t.same(5,array2.length, 'pipe to multiple dest diff tick')
			t.end()
		}),
		{pace:20})
	})
	


})



function makeBuffArray(){
	var arr = []
	for(var i=0; i<5;i++){
		var buff = new Buffer(20)
		buff.fill('X')
		arr.push(buff)
	}
	return arr
}